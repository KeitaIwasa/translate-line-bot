# インターフェース仕様書

本ドキュメントは、LINE 多言語翻訳ボットにおける主要コンポーネント（LINE API / API Gateway / Lambda / Neon / Gemini）の連携仕様を示す。

## 1. 全体フロー概要

1. LINE Messaging API から Webhook イベントが API Gateway HTTP API に POST される。
2. API Gateway がイベントを Lambda 関数（Python 3.12）に渡す。
3. Lambda は署名検証後、イベントを解析し、Neon から言語設定と文脈を取得する。
4. Lambda は同一リクエスト内で Gemini 2.5 Flash へ翻訳要求を送信し、Structured Output を受信する。
5. Lambda は翻訳結果を LINE Messaging API の Reply API または Push API に送信し、その完了を待つ。
6. Lambda がすべての処理を完了後に API Gateway へ `200 OK` を返却する。
7. 各ステップで失敗した場合は所定のリトライ・無視ポリシーに従う。

## 2. LINE Messaging API → API Gateway

- **エンドポイント**: `POST https://{api_id}.execute-api.{region}.amazonaws.com/webhook`
- **認証**: LINE Messaging API より付与されるチャネルアクセストークンによる署名（`X-Line-Signature`）。
- **ヘッダー**:
  - `Content-Type: application/json`
  - `X-Line-Signature: <signature>`
- **リクエストボディ（例）**:
```json
{
  "destination": "Uxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
  "events": [
    {
      "type": "message",
      "timestamp": 1732060800000,
      "source": {"type": "group", "groupId": "Cxxxxxxxxxx", "userId": "Uyyyyyyyyyy"},
      "replyToken": "abcd1234",
      "message": {
        "id": "1234567890",
        "type": "text",
        "text": "@John これめっちゃおいしい！"
      }
    }
  ]
}
```
- **レスポンス**: API Gateway は Lambda からの返却（通常 `200` 空ボディ）。

## 3. API Gateway → Lambda

- **統合タイプ**: Lambda プロキシ統合（HTTP API）。
- **イベント形式**: `requestContext`, `headers`, `body` を含む JSON。`body` は LINE Webhook JSON をそのまま文字列で含む。
- **制御要件**:
  - Lambda は翻訳完了後に `200 OK` を返却する同期フロー。タイムアウトは 5 秒程度を推奨。
  - 署名検証失敗時は `403` を返却し、処理中断。

## 4. Lambda → Neon (PostgreSQL)

- **接続方式**: `psycopg` を用いた直接接続。接続文字列は `NEON_DATABASE_URL` 環境変数。
- **利用テーブル**:
  - `group_members`（言語設定）
  - `messages`（メッセージ履歴）
- **グループ翻訳言語の上限**: 1 グループあたり最大 5 言語。超過指定時は処理せず再入力を促す。
- **主要クエリ**:
  1. 言語設定取得
     ```sql
     SELECT user_id, preferred_lang
     FROM group_members
     WHERE group_id = $1;
     ```
  2. 文脈取得（bot 投稿除外、最大20件）
     ```sql
     SELECT user_id, text, timestamp
     FROM messages
     WHERE group_id = $1 AND user_id <> $2
     ORDER BY timestamp DESC
     LIMIT 20;
     ```
     - 取得後、Lambda 側で時系列（古い→新しい）になるようリストを反転して Gemini に渡す。
  3. メッセージ保存
     ```sql
     INSERT INTO messages (group_id, user_id, text)
     VALUES ($1, $2, $3);
     ```
- **エラーハンドリング**:
  - 接続失敗・クエリ失敗時は即座に中断し、該当メッセージ処理を無視。
  - トランザクションは各操作単位で完結させ、長時間ロックを避ける。

## 5. Lambda → Gemini 2.5 Flash

- **エンドポイント**: `POST https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent`
- **認証**: `x-goog-api-key: <GEMINI_API_KEY>`
- **リクエスト構成**:
  - **prompt**: 文脈メッセージ（最大20件、時系列順：古い→新しい）と現在の原文メッセージ情報。
  - **プロンプト指示**: 話者名とメンション（例：`@John`）は翻訳対象から除外し、出力にも原文どおり残すことを明記する。
  - **structured output schema**: 要件定義書 FR-2 と同一の翻訳結果 JSON（例）
    ```json
    {
      "type": "object",
      "properties": {
        "translations": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "lang": {"type": "string"},
              "text": {"type": "string"}
            },
            "required": ["lang", "text"]
          }
        }
      },
      "required": ["translations"]
    }
    ```
- **再試行ポリシー**:
  - 壊れたレスポンスや JSON バリデーション失敗時に最大 3 回まで再試行。
  - それ以外の失敗（HTTP エラー等）は即座に無視。
- **応答処理**:
  - 応答内の翻訳結果から、原文言語のメンション文字列を保持したままテキストを生成する。
  - 長文は Gemini から返却された範囲でそのまま使用し、補間しない。

## 6. Lambda → LINE Messaging API（返信）

- **エンドポイント**: `POST https://api.line.me/v2/bot/message/reply`
- **認証**: `Authorization: Bearer <LINE_CHANNEL_ACCESS_TOKEN>`
- **ヘッダー**: `Content-Type: application/json`
- **リクエストボディ（例）**:
```json
{
  "replyToken": "abcd1234",
  "messages": [
    {
      "type": "text",
      "text": "@John これめっちゃおいしい！\n@John This is super delicious!\n@John อันนี้อร่อยมาก!"
    }
  ]
}
```
- **部分成功ハンドリング**: 翻訳が一部言語のみ成功した場合は成功した言語分だけメッセージ配列を組み立てる。
- **失敗時**: LINE API からエラーが返った場合は再試行せず、処理を終了。

## 7. 環境変数・秘密情報

| キー | 用途 |
| ---- | ---- |
| `LINE_CHANNEL_SECRET` | Webhook 署名検証用 |
| `LINE_CHANNEL_ACCESS_TOKEN` | LINE API 送信用 |
| `NEON_DATABASE_URL` | PostgreSQL 接続 |
| `GEMINI_API_KEY` | Gemini API 呼び出し |

秘密情報は Lambda 環境変数で管理し、ローテーション時はデプロイパイプライン経由で更新する。

## 8. エラーと監視

- CloudWatch Logs に以下を記録する：
  - 署名検証失敗
  - Neon 接続 / クエリエラー
  - Gemini 呼び出しエラー・再試行状況
  - LINE API 応答コード
- メトリクス：
  - 翻訳成功数 / 失敗数
  - 平均レイテンシ（Webhooks 処理時間、Gemini 応答時間）
  - 再試行回数
- アラート条件（例）：
  - 5 分間に失敗が 5 回以上連続
  - Gemini エラー率 > 20%

以上。
