# 翻訳プロンプト & Structured Output 仕様

LINE 多言語翻訳ボットで Gemini 2.5 Flash を呼び出す際のプロンプト構成と JSON Schema を定義する。

## 1. System Instruction

Gemini 呼び出し時の system ロールは以下を使用する。

```
You are a translation engine for a multi-language LINE group.

You receive a JSON object with:
- "source_message": the message to translate, including sender information.
- "context_messages": recent messages in the same group, each with sender information.
- "target_languages": an array of language codes to translate into.

Requirements:
- Use "source_message.text" as the text to translate.
- Use "context_messages" only to understand the context and who is talking to whom.
- Preserve user names (sender_name) as they are. Do NOT translate names.
- Preserve mention strings (e.g., "@John") exactly as they appear in the source text.
- Use natural, context-aware translations.
- Return ONLY a JSON object that matches the given JSON Schema.
- Do NOT include context_messages or target_languages in the output JSON.
```

## 2. User メッセージ構成

- 単一の JSON 文字列を user ロールで渡す。
- `context_messages` は時系列（古い→新しい）。
- メンションや sender_name は改変しない。

```json
{
  "source_message": {
    "sender_name": "Keita",
    "text": "@John これめっちゃおいしい！",
    "timestamp": "2025-11-19T12:34:56Z"
  },
  "context_messages": [
    {
      "sender_name": "Keita",
      "text": "みんなで居酒屋に来ています。",
      "timestamp": "2025-11-19T12:33:00Z"
    },
    {
      "sender_name": "Alice",
      "text": "この唐揚げ、人生で一番おいしいかもしれない。",
      "timestamp": "2025-11-19T12:33:30Z"
    }
  ],
  "target_languages": ["en", "th"]
}
```

## 3. Structured Output JSON Schema

Gemini の Structured Output に設定するスキーマは要件定義書 FR-2 と同一とし、以下の通り。

```json
{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "type": "object",
  "properties": {
    "translations": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "lang": {
            "type": "string",
            "description": "ISO 639-1 language code for the translation"
          },
          "text": {
            "type": "string",
            "description": "Translated text. Preserve mentions such as @John."
          }
        },
        "required": ["lang", "text"],
        "additionalProperties": false
      }
    }
  },
  "required": ["translations"],
  "additionalProperties": false
}
```

## 4. サンプル入出力

### 入力（system + user）

- system: 上記 System Instruction
- user: 前節の JSON

### 期待される応答（例）

```json
{
  "translations": [
    {
      "lang": "en",
      "text": "@John This is super delicious!"
    },
    {
      "lang": "th",
      "text": "@John อันนี้อร่อยมาก!"
    }
  ]
}
```

### バリデーション要件

- `translations` に含める言語は `target_languages` のみ。
- メンションや sender_name を翻訳したり削除したりしない。
- JSON 以外のテキスト、補足説明、コードブロックは返さない。
- 壊れたレスポンス検出時は Lambda 側で最大 3 回まで再試行する。
