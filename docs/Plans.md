# LINE グループ名保存対応 ToDo

- 背景: 現状の Join 処理ではボット参加時に `joined_at` の記録・言語設定リセット・翻訳停止設定のみ行っており、グループ名を保持していない。ステータス画面や課金連携でグループ名参照できるよう、参加時に LINE からグループ名を取得して永続化する。

## 運用・監視メモ
- 2025-12-10 16:05 JST のステージングで翻訳レスポンスが返らなかった。Webhook 受信時のイベント種別・候補言語・クオータ判定を CloudWatch に出すロギングを追加済み。デプロイ後に再現した場合、追加ログを起点に payload フィルタ漏れや quota 停止の有無を確認する。
- 2025-12-10 16:28 JST の「こんにちは2」ではクオータ判定で翻訳停止となった。ロギング文言を詳細化（plan/usage/limit をメッセージ内に出力）したので、以降はログだけで数値まで確認可能。
- 2025-12-10 翻訳失敗時にクオータが戻らず消費される不具合を修正。翻訳が空配列/例外の場合は usage をロールバックする。
- 2025-12-10 17:30 JST ステージングで「@STG 通訳AI 通訳再開」返信が日本語重複になった件を調査。ベース文を英語前提に固定し、英語行は翻訳せず他言語のみ翻訳するよう `_build_multilingual_interface_message` を修正（英訳を挟まない方針に再調整）。
- 2025-12-10 20:05 JST 言語設定完了メッセージに英語行が混入する問題を修正。設定言語に英語が含まれる場合だけ英語行を出し、非英語だけ翻訳して並べるよう `_build_multilingual_completion_message` を変更。
- 2025-12-10 20:30 JST アラビア語行の句読点が右端に表示される件を調査。言語設定完了メッセージで RTL 行に双方向ラップを適用し、句読点位置が安定するよう `_build_multilingual_completion_message` に RTL 判定＆ラップを追加。
- 2025-12-10 20:45 JST 句読点が右寄りに残る問題を再修正。RTL 行末に RLM を付与するよう `_wrap_bidi_isolate` を更新し、テストを調整。
- 2025-12-10 21:10 JST 使い方説明などインターフェース文言も RTL 句読点が右寄りになる箇所があったため、`_build_multilingual_interface_message` で各行に双方向ラップを適用するよう修正。
- 2025-12-10 21:25 JST RTL 行の先頭にも RLM を追加し、行全体を強制的に RTL として固定（句読点の視覚位置をさらに安定化）。対応に合わせて bidi テスト期待値を更新。
- 2025-12-10 21:40 JST 使い方説明レスポンスでも bidi ラップを適用し漏れを解消。`_build_usage_response` に `_wrap_bidi_isolate` を組み込み、専用テスト `test_message_handler_usage.py` を追加。

## 実装タスク
- スキーマ拡張: `group_settings` に `group_name` 列（NULL 許可）を追加するマイグレーションを作成し、既存データを保持したままアップサートできるようにする。
- ポート設計: `LinePort` にグループサマリ取得（名称返却）のメソッドを追加し、`MessageRepositoryPort` にグループ名を保存するメソッドを追加する。
- LINE API 実装: `/v2/bot/group/{groupId}/summary` を呼び出して `displayName` を取得する実装を追加し、失敗時は `None` でフォールバックする。
- リポジトリ実装: 新メソッドで受け取ったグループ名を `group_settings` に upsert するロジックを追加し、`translation_enabled` を壊さないようにする。
- Join ハンドラ改修: 参加イベント時にグループサマリを取得→グループ名を保存→既存の join_time 記録・言語設定リセット・翻訳停止設定・初期プロンプト送信を行う。取得失敗時は従来フロー継続。
- テスト追加: Line API グループサマリ取得の正常系/404/エラーハンドリングのテスト、Join ハンドラのグループ名保存呼び出し有無をモックで検証するテストを追加。必要に応じてリポジトリの upsert 挙動を単体テスト。

## リリース手順
- `pytest` を実行して全テストが通ることを確認する。
- ステージング環境にデプロイし、LINE グループでボットを再招待してグループ名が保存されることを確認する。

# グループ退会時のサブスクリプション自動キャンセル ToDo

- 背景: ボットがグループから退会させられた場合も課金が継続してしまうリスクがある。退会イベントをトリガーにサブスクリプションを自動解約し、二重請求を防ぐ。

## 実装タスク
- イベント検知: LINE の leave/unfollow/room 退室イベントのうちグループ退会に該当するイベントを Webhook で捕捉するか既存ハンドラを確認し、未対応ならハンドラを追加する。
- ドメインサービス: 退会イベントから対象グループのサブスクリプション情報を特定し、キャンセルを指示するユースケース（アプリケーションサービス）を追加する。
- 決済ポート: サブスクリプションキャンセルを呼び出すメソッドを決済ポートに追加し、既存プロバイダ実装（例: Stripe）に反映する。キャンセル時のステータス更新やエラー処理方針を定義する。
- リポジトリ更新: グループ設定/サブスクリプションの永続層にキャンセル反映（状態更新・キャンセル日時記録）を追加し、冪等性を確保する。
- ロギング/通知: 自動キャンセル結果を監査ログに残し、必要に応じて管理者通知（例: Slack, メール）を行う。
- テスト追加: 退会イベント受信からキャンセル完了までのフローをモックでカバーする統合テストと、キャンセル失敗時のリトライ/スキップ挙動の単体テストを追加する。
- 退会イベント時に `group_usage_counters.limit_notice_plan` を NULL へリセットし、再招待後でも上限到達通知を再送できるようにする。

## リリース手順
- `pytest` を実行して全テストが通ることを確認する。
- ステージング環境にデプロイし、グループからボットを削除してサブスクリプションが自動キャンセルされることを確認する。

# Proプラン申し込み導線改善 ToDo

- 背景: Stripe Checkout へ直接遷移していた導線を、事前案内ページ経由に変更し、安全に決済へ進めるようにする。

## 対応済み 2025-12-10
- `pages/index.html` に多言語対応（日本語・英語・繁体字・タイ語）の Pro 申込ページを新設。
- クエリの `session_id`／`sessionId` がある場合のみ「Proプランを購入」ボタンを表示し、`/checkout` へ遷移する短縮リンクを付与。
- パラメータ欠如時はボタンを隠し、正しい招待リンク経由でのアクセスを促す文言を表示。
- 規約リンク（利用規約・プライバシーポリシー）と料金表、Free/Pro 比較表、利用開始フロー、注意事項をページに集約。

# Stripe 解約イベント反映（補足メモ）
- Stripe 側でユーザーがサブスクリプションをキャンセルした場合、`customer.subscription.deleted` Webhook を `src/stripe_webhook_handler.py` で受信し、`group_subscriptions` に `status=canceled` を upsert、`group_settings.translation_enabled` を `False` に更新している。`metadata.group_id` が必須なので、Checkout セッション作成時に `group_id` を metadata に含めること。

# サブスク解約済みの再解約リクエスト対応 ToDo

- 解約済みや未加入状態ではキャンセル確認テンプレートを出さず、プロ未加入メッセージを返す（ボタンテンプレートと同じ言語で返信する）。
- Postback の payload に instruction_lang を含め、応答メッセージの言語選択に利用する。
- PostbackHandler に単一言語翻訳ヘルパーを追加し、テストで挙動を確認する。

## 対応済み 2025-12-10
- 解約済みや未加入状態でサブスク解約ボタン/メンションを受けた場合、キャンセル確認テンプレートを出さずプロ未加入メッセージを返すように変更（ボタン言語を優先し、なければグループ主要言語で返信）。
- langdetect の乱数シード固定で検出結果のブレを防止。
- サブスク未加入の場合、メニューから「Cancel subscription」ボタンを非表示にするよう調整。
