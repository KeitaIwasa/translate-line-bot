# 2025-11-30 メンション経由の機能提供追加計画

## ゴール
- グループ内でボットがメンションされたときだけ、指示言語に合わせて機能応答できること。
- 指示文を Gemini で判定し、言語設定変更 / 使い方説明 / 翻訳停止・再開 を Lambda 側で実行すること。
- どの機能にも該当しない場合に案内文を返し、通常翻訳を再開できること。

## タスク（ToDo）
- [x] メンション検知の要件整理: 環境変数でボット名を持たせ、LINE メッセージからメンション有無を判定するルールを決める。
- [x] Gemini コマンド判定スキーマ設計: 4 操作種別（言語設定、使い方、停止、再開、その他）と、言語設定内の操作タイプ（リセット/追加/削除/追加+削除）＋対象言語配列を Structured Output で受け取るプロンプトを定義。
- [x] ルーティング実装: MessageHandler でメンション付き指示を拾い、判定結果に応じて各モードへ分岐。通常翻訳との共存ルール（メンションなしは従来通訳継続）を整理。
- [x] 言語設定モード実装: 
  - [x] リセット&再設定フロー（既存の言語確認テンプレートを流用）
  - [x] 部分追加/削除/追加+削除の DB 更新メソッドをリポジトリに追加
  - [x] 言語設定中は翻訳停止、完了時に自動再開（translation_enabled フラグで制御）
- [x] 使い方説明: 固定メッセージを設定済み言語すべてに Gemini で翻訳し列挙、指示言語でのレスポンスも担保。
- [x] 翻訳停止/再開: グループ単位の停止フラグを永続化（group_settings テーブル）、状態に応じて翻訳処理をスキップ＆再開通知。
- [x] 非該当時の案内: 指示言語でガイダンスを返し、翻訳を再開する挙動を実装。
- [x] 環境変数・デプロイ設定更新: BOT メンション名や新モデル設定を `config.py`/`template.yaml`/`scripts/deploy.sh` に反映（BOT_MENTION_NAME は Secrets Manager 経由）。
- [ ] テスト追加・修正: コマンド判定、メンションルーティング、停止/再開フラグ、部分言語更新のリポジトリ挙動など。
- [ ] テスト実行: ローカル pytest 実行での動作確認。問題があれば、修正。
- [ ] ドキュメント更新: `要件定義書.md`, README, `AGENTS.md` に新しい操作方法、環境変数、運用手順などを追記。

## メモ/前提
- デプロイは `scripts/deploy.sh`（STAGE ごとに Secrets 名が変わる）。ローカルタイムアウトは 300–600 秒に設定する。
- 本番スタック: STACK_NAME=translate-line-bot-prod, HttpApiEndpoint=https://h2xf6dwz5e.execute-api.ap-northeast-1.amazonaws.com/prod。
