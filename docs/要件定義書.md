# 要件定義書

**LINE 多言語翻訳ボット（Multilingual Translation Bot）**

---

## 1. 概要（Purpose）

本システムは、LINE グループ内における多国籍メンバー間コミュニケーションを支援するため、
ユーザーが投稿したメッセージを **他メンバーの希望言語にリアルタイム翻訳するボット**である。

Gemini 2.5 Flash の Structured Output による高速かつ自然な翻訳を活用し、
AWS Lambda（Python）＋ Neon（PostgreSQL）を使用した最小構成で低レイテンシを実現する。

---

## 2. 対象範囲（Scope）

本ドキュメントが対象とする内容：

* LINE Messaging API を用いた多言語翻訳ボットの仕様
* ユーザー・グループの言語設定管理
* 翻訳処理の設計
* 外部サービス連携（Gemini / Neon / LINE）
* MVP（最小構成）としてのアーキテクチャ・非機能要件

---

## 3. システム機能要件（Functional Requirements）

---

### 3.0 メンション経由の操作（ボット制御）

#### FR-0：ボットメンション検知

* メッセージ本文に `@<BOT_MENTION_NAME>`（環境変数、デフォルト `@通訳AI`、大文字小文字・全半角スペース無視）が含まれる場合のみ「コマンドモード」とみなし、メンション部分を除いた残りテキストを指示文として扱う。
* メンションが無いメッセージは従来どおり自動翻訳フローに送る（コマンド判定は行わない）。

#### FR-1：Gemini による指示判定

* 指示文を Gemini（`COMMAND_MODEL`、Structured Output）で分類し、以下のいずれかのアクションを返す：`language_settings` / `howto` / `pause` / `resume` / `unknown`。
* `language_settings` の場合は追加情報として `operation`（`reset_all` / `add` / `remove` / `add_and_remove`）、`languages_to_add` / `languages_to_remove` を JSON で受け取る。
* `instruction_language` は BCP-47/ISO639-1 で返し、`ack_text` は指示言語で簡潔に返す（メンション文言を含めない、原文エコー禁止）。

#### FR-2：翻訳一時停止 / 再開

* `pause` でグループ単位の `translation_enabled=false` を Neon `group_settings` に保存し、それ以降の投稿は翻訳せずログのみ記録する。
* `resume` または言語設定完了後に `translation_enabled=true` とし、通常翻訳を再開する。
* 言語設定リセット開始時（`reset_all`）やボット再招待時は安全側で `translation_enabled=false` とする。

#### FR-3：操作ガイダンス

* `howto` では固定メッセージ（日本語原文）を、指示言語＋設定済み言語すべてに翻訳して列挙する。設定言語に `ja` が含まれる場合は必ず日本語原文を先頭に含める。
* `unknown`（判定不能）時は指示言語を自動判定し、メンション経由で利用できる操作リスト（言語設定変更／使い方／翻訳停止）を案内する。案内後は `translation_enabled=true` として通常翻訳へ戻す。

---

### 3.1 メッセージ翻訳機能

#### FR-4：自動翻訳

* ユーザーがグループに投稿した**テキストメッセージのみ**を対象に自動翻訳する（スタンプ・画像などは対象外）。
* 翻訳対象は、**グループ内メンバーの希望言語セット − 原文の言語**。
* メンション付きメッセージでは、メンション文字列（例：`@John`）を翻訳対象から除外しつつ、翻訳結果にも原文通り残す。
* 長文は Gemini が生成できる範囲まで翻訳し、省略時はそのまま切り詰めた形で返信する。

#### FR-5：一括翻訳出力

翻訳結果は以下の形式で同一メッセージにまとめて出力する。

原文：
```
これめっちゃおいしい！
```

翻訳結果：
```
This is super delicious!
อันนี้อร่อยมาก!
```

* 入力JSON：
```json
{
  "source_text": "これめっちゃおいしい！",
  "source_message": {
    "sender_name": "Keita",
    "text": "これめっちゃおいしい！",
    "timestamp": "2025-11-19T12:34:56Z"
  },
  "context_messages": [
    {
      "sender_name": "Keita",
      "text": "みんなで居酒屋に来ています。",
      "timestamp": "2025-11-19T12:33:00Z"
    },
    {
      "sender_name": "Alice",
      "text": "この唐揚げ、人生で一番おいしいかもしれない。",
      "timestamp": "2025-11-19T12:33:30Z"
    }
  ],
  "target_languages": ["en", "th"]
}

```

#### FR-6：文脈考慮

* 翻訳時、直近 **最大8件** のメッセージを文脈として LLM に渡す（bot自身の投稿は除外）。
* 文脈メッセージは取得時点の順序を使用し、厳密な順序保証は要求しない。
* 文脈には以下を含む：

  * sender_name
  * text
  * timestamp

#### FR-7：話者名は翻訳しない

* 各メッセージの発言者名は翻訳対象外とし、そのまま扱う。

---

### 3.2 言語設定機能

#### FR-8：グループ言語登録

* ボットがグループに招待された際（再招待含む）は、既存の言語設定をリセットし、以下のメッセージをグループ内へ送信して全員に再設定を促す：

```
Hello! I'm a multilingual translation bot. Please tell me the languages you want to translate to.
你好！我是一个多语言翻译机器人。请告诉我你想要翻译成哪些语言。
こんにちは！多言語翻訳ボットです。翻訳したい言語を教えてください。
สวัสดี! ฉันเป็นบอทแปลหลายภาษา กรุณาบอกฉันว่าคุณต้องการแปลเป็นภาษาใดบ้าง
ex) English, 中文, 日本語, ไทย
```

* 単一ユーザーから友だち追加された場合は言語設定は不要で、簡単な挨拶メッセージのみ送信する（多言語グループ前提のフローは実行しない）。
* ユーザーが言語名を返信すると、直前メッセージに含まれる言語を Gemini で抽出し（ISO コード＋自然文）、空の結果でなければ「確認テンプレート」で一括確認を行う。テンプレート本文とボタンテキストは LLM から返される `confirm`/`completed`/`cancel`/`primaryLanguage` を優先し、足りない場合は基準文を指示言語へ翻訳した結果を使う。payload には `primary_language` と各テキストを含め、Postback 側はそのまま返信する（fallback は日本語固定文言）。
* テンプレートで「完了（🆗）」が押された場合は、登録した言語リストを多言語で再通知しつつ `group_languages` に保存し、`translation_enabled=true` に戻す。「変更する（↩️）」が押された場合は `translation_enabled=false` のままキャンセル文面を返す。
```json
{
  "type": "template",
  "altText": "this is a confirm template",
  "template": {
    "type": "confirm",
    "text": "日本語を追加しますか？",
    "actions": [
      {
        "type": "postback",
        "label": "はい",
        "data": "language_enroll=ja&enroll=true"
      },
      {
        "type": "postback",
        "label": "いいえ",
        "data": "language_enroll=ja&enroll=false"
      }
    ]
  }
}
```
 https://developers.line.biz/ja/reference/messaging-api/#template-messages
* `language_settings` の操作では、以下の種類を受け付ける：
  * `reset_all`: 既存設定を全削除し、言語再設定を促す（翻訳停止）。
  * `add`: 指定言語を追加保存する。
  * `remove`: 指定言語を削除する。
  * `add_and_remove`: 上記の組み合わせ。
* LLM で言語名を正規化し、ISO 言語コード（例：`en`）に変換して保存する。入力形式は自由（自然文／絵文字など任意）で受け付け、正規化に失敗または抽出結果が空の場合は言語指定ではないメッセージとみなし、レスポンスを返さず無視する。
* LLM で言語名を正規化し、ISO 言語コード（例：`en`）に変換して保存する。入力形式は自由（自然文／絵文字など任意）で受け付け、正規化に失敗または抽出結果が空の場合は言語指定ではないメッセージとみなし、レスポンスを返さず無視する。

* 追加要件（memberJoined イベント）:
  * グループに新メンバーが追加されたとき、ボットは以下の多言語メッセージで歓迎し、言語設定の変更方法を案内する：

```
Hello <参加者名> !

When you want to change the interpreter's language settings, please remove this bot from the group once and then invite it again!

通訳の言語設定を変更するときは、このボットを一度グループから削除してから、再度招待してね！

如果你想更改口译语言设置，请先将此机器人从群组中删除，然后再重新邀请它！

หากคุณต้องการเปลี่ยนการตั้งค่าภาษาของล่าม กรุณานำบอทนี้ออกจากกลุ่มก่อน แล้วค่อยเชิญกลับมาอีกครั้ง!
```

  * ただし、**ボットがグループに参加してから10分以内に追加された新メンバー**については、このメッセージを送信しない（再招待直後のスパムを防止）。ボット自身のユーザーIDは存在しないため、グループ毎に特殊な `user_id="__bot_join__"` レコードで参加時刻を記録して判定する。

#### FR-9：対応可否判定

* Gemini により、その言語が翻訳可能か判定する。
* 未対応言語が含まれている場合は、以下の多言語メッセージで通知した後、対応可能な言語だけを使って確認テンプレートを送信する。対応可能な言語が 1 つも無い場合は通知のみで終了し、テンプレートは送信しない。
```
シルボ語には通訳対応できません。
I cannot provide interpretation for Silbo language.
ฉันไม่สามารถให้บริการล่ามสำหรับภาษาซิลโบได้
我無法提供席耳波語的口譯服務。
```

#### FR-10：グループ内の言語保持

* グループ単位で翻訳先言語のリストを保持し、翻訳先選定に使用。言語設定自体は `group_languages` テーブルで管理し、確認テンプレートで「完了（🆗）」が押されたときにまとめて登録する。言語設定の可視化・更新機能は現時点では提供しない。

---

### 3.3 メッセージ履歴保持

#### FR-11：メッセージログ保存

* 各メッセージを Neon に保存し、CloudWatch Logs で必要な計測を行う（追加の分析基盤は不要）。
* 翻訳時の文脈として **直近8件** を取得する。8件未満の場合は取得できたメッセージすべてを文脈として渡し、補間は行わない。

#### FR-12：保存期間

* MVP段階では **半永久保存** とする。

---

### 3.4 外部サービス連携

#### FR-13：Gemini 連携

* 翻訳・UI応答・コマンド判定は Gemini の Structured Output を利用する。
  * 翻訳用: `GEMINI_MODEL`
  * コマンド判定用: `COMMAND_MODEL`（既定は翻訳モデルと同じ）
* LLMコールは各用途で1回のみ。翻訳・インターフェース翻訳・コマンド判定はいずれも **10秒タイムアウト** を設定し、最大2回まで再試行する。
* プロンプトでは話者名・メンションを翻訳対象から除外し、翻訳結果内にも原文のまま残すよう指示する。

#### FR-14：LINE Messaging API

* 翻訳結果は Reply API / Push API で送信する。

#### FR-15：NeonDB連携

* 言語設定
* メッセージ履歴
  を取得・保存する。

---

## 4. 非機能要件（Non-Functional Requirements）

---

### 4.1 パフォーマンス

#### NFR-1：応答速度

* Webhook 受信時の応答は **1秒以内に 200 OK** を返す（翻訳・コマンド処理は非同期で継続）。
* LLM 呼び出し（翻訳・UI 応答・コマンド判定）は **10秒タイムアウト** を設け、Lambda の `FunctionTimeout` は **20秒** に設定する。
* 実運用目安として翻訳完了までは 1–2 秒程度を想定し、タイムアウト時はエラーメッセージを返さずログのみ残す。

#### NFR-2：LLM 呼び出し回数

* 翻訳時の LLM 呼び出しは **1回**。
* UI 応答（使い方案内、停止/再開通知など）も 1 回の翻訳コールで多言語化する。
* コマンド判定は 1 回の Structured Output 生成で完結させる。

#### NFR-3：DBアクセス数

* 通常翻訳フローでは Neon アクセスを **最大4回** までとする：

  * 翻訳停止フラグ取得 1 回
  * 言語設定取得 1 回
  * 文脈最大8件取得 1 回
  * メッセージ保存 1 回

---

### 4.2 可用性

#### NFR-4：障害時対応

* LLMまたはNeon障害時や、翻訳失敗時は当該メッセージを無視して終了する（ユーザーへの追加返信なし）。
* 部分的に成功した場合は、取得できた翻訳結果のみ返信する。
* LLM からの壊れたレスポンスを受け取った場合は最大3回まで再試行し、それでも失敗すれば無視とする。
* 連続5回以上エラーの場合、管理者へ通知（後日実装可）。

---

### 4.3 セキュリティ

#### NFR-5：署名検証

* LINE Webhook の `X-Line-Signature` を検証し不正リクエストを拒否。

#### NFR-6：API鍵管理

* LINE / Gemini / Neon の認証情報は Lambda の環境変数で管理。

#### NFR-7：安全なログ管理

* 個人情報を含むログへのアクセスは制御する。
* MVP段階ではデータ削除運用は考慮せず、将来の機能追加で対応する。

---

### 4.4 拡張性

#### NFR-8：構成のシンプルさ

* MVPでは高速動作を優先し、以下は使用しない：

  * キャッシュ（Redis / Upstash）
  * SQS
  * Step Functions
  * 多段Lambda
  * CDK/Terraform

#### NFR-9：モジュール分離

* 翻訳ロジックと外部APIロジックを分離し、将来の LLM 切替が容易であること。

---

## 5. システム構成要件（Architecture Requirements）

---

### 5.1 全体構成

```
LINE → API Gateway → Lambda
                      ├→ NeonDB
                      ├→ Gemini 2.5 Flash
                      └→ LINE API Reply
```

---

### 5.2 Lambda（Python）

* Runtime: Python 3.12
* Handler: `lambda_handler.lambda_handler`

主要役割：

1. LINE Webhook イベント受信
2. すぐ 200 を返却
3. メンション有無を判定し、ある場合は Gemini でコマンド分類（言語設定/使い方/停止/再開/未知）
4. 言語設定の保存・追加削除・翻訳停止フラグの更新を行い、必要に応じて多言語ガイダンスを返信
5. 翻訳を実行する場合：言語設定取得（Neon）→ 文脈取得（Neon）→ 翻訳先言語リスト生成
6. Gemini 2.5 Flash に Structured Output 翻訳依頼（最大8件の文脈付き）
7. 翻訳結果を LINE Messaging API へ送信

---

### 5.3 NeonDB（PostgreSQL）

#### テーブル：`group_languages`

| column    | type        | note                           |
| --------- | ----------- | ------------------------------ |
| group_id  | TEXT        | PK（`group_id`,`lang_code`）   |
| lang_code | VARCHAR(10) | ISO 言語コード（小文字統一）    |
| lang_name | TEXT        | 自然文の言語名                 |
| created_at| TIMESTAMPTZ | DEFAULT NOW()                  |

#### テーブル：`group_settings`

| column               | type      | note                            |
| -------------------- | --------- | ------------------------------- |
| group_id             | TEXT      | PK                              |
| translation_enabled  | BOOLEAN   | 通訳稼働フラグ（デフォルト TRUE）|
| updated_at           | TIMESTAMPTZ | DEFAULT NOW()                 |

#### テーブル：`messages`

| column    | type      | note                          |
| --------- | --------- | ----------------------------- |
| id        | SERIAL    | PK                            |
| group_id  | TEXT      |                               |
| user_id   | TEXT      |                               |
| sender_name | TEXT    | 表示名を冗長保存               |
| text      | TEXT      |                               |
| timestamp | TIMESTAMPTZ | DEFAULT NOW()               |

---

### 5.4 Gemini（LLM）

* モデル：**Gemini 2.5 Flash**
* 要求：

  * Structured Output（JSON Schema）
  * context（8件まで）
  * output JSON に余計な内容は含めない
* JSON Schema：
```json
{
  "type": "object",
  "properties": {
    "source_text": { "type": "string" },
    "detected_source_language": { "type": "string" },
    "translations": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "language_code": { "type": "string" },
          "text": { "type": "string" }
        },
        "required": ["language_code", "text"]
      }
    }
  },
  "required": ["source_text", "translations"]
}
```

* コマンド判定用 Structured Output（概要）：
  * `action`: `language_settings` / `howto` / `pause` / `resume` / `unknown`
  * `operation`: `reset_all` / `add` / `remove` / `add_and_remove`（action が language_settings のとき）
  * `languages_to_add` / `languages_to_remove`: `{ code, name }` 配列
  * `instruction_language`: BCP-47 or ISO639-1
  * `ack_text`: 指示言語での簡潔な応答

---

## 6. データフロー（Data Flow）

1. ユーザーがメッセージ送信
2. LINE → Webhook → API Gateway → Lambda
3. Lambda が即 200 OK
4. Lambda 内部で非同期処理：

   * メンション有無を判定し、あれば Gemini でコマンド分類
   * 言語設定更新 / 翻訳停止フラグの保存 / 使い方または UNKNOWN ガイダンスを返信
   * 翻訳有効な場合のみ、言語設定取得→文脈（最大8件）取得→ Gemini に翻訳要求
   * 翻訳結果または UI 応答を LINE へ返信
   * 原文メッセージを保存
5. グループに翻訳結果または操作応答が表示される

---

## 7. 制約（Constraints）

* LINE Webhook 応答は 2 秒以内
* LLM API のレート制限を遵守
* Neon 接続は Lambda から直接行う（Connection pooling は使用しない）
* 高速化のため費用最優先ではなく性能を優先（Gemini Flash）

---

## 8. 今後の拡張（Future Work）

（MVP後に検討）

* キャッシュ導入（Upstash Redis）
* 管理画面（Next.js）
* 過去ログのアーカイブ
* 課金システム（Stripe）
