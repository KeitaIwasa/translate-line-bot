# 要件定義書

**LINE 多言語翻訳ボット（Multilingual Translation Bot）**

---

## 1. 概要（Purpose）

本システムは、LINE グループ内における多国籍メンバー間コミュニケーションを支援するため、
ユーザーが投稿したメッセージを **他メンバーの希望言語にリアルタイム翻訳するボット**である。

Gemini 2.5 Flash の Structured Output による高速かつ自然な翻訳を活用し、
AWS Lambda（Python）＋ Neon（PostgreSQL）を使用した最小構成で低レイテンシを実現する。

---

## 2. 対象範囲（Scope）

本ドキュメントが対象とする内容：

* LINE Messaging API を用いた多言語翻訳ボットの仕様
* ユーザー・グループの言語設定管理
* 翻訳処理の設計
* 外部サービス連携（Gemini / Neon / LINE）
* MVP（最小構成）としてのアーキテクチャ・非機能要件

---

## 3. システム機能要件（Functional Requirements）

---

### 3.1 メッセージ翻訳機能

#### FR-1：自動翻訳

* ユーザーがグループに投稿した**テキストメッセージのみ**を対象に自動翻訳する（スタンプ・画像などは対象外）。
* 翻訳対象は、**グループ内メンバーの希望言語セット − 原文の言語**。
* メンション付きメッセージでは、メンション文字列（例：`@John`）を翻訳対象から除外しつつ、翻訳結果にも原文通り残す。
* 長文は Gemini が生成できる範囲まで翻訳し、省略時はそのまま切り詰めた形で返信する。

#### FR-2：一括翻訳出力

翻訳結果は以下の形式で同一メッセージにまとめて出力する。

原文：
```
これめっちゃおいしい！
```

翻訳結果：
```
This is super delicious!
อันนี้อร่อยมาก!
```

* 入力JSON：
```json
{
  "source_text": "これめっちゃおいしい！",
  "source_message": {
    "sender_name": "Keita",
    "text": "これめっちゃおいしい！",
    "timestamp": "2025-11-19T12:34:56Z"
  },
  "context_messages": [
    {
      "sender_name": "Keita",
      "text": "みんなで居酒屋に来ています。",
      "timestamp": "2025-11-19T12:33:00Z"
    },
    {
      "sender_name": "Alice",
      "text": "この唐揚げ、人生で一番おいしいかもしれない。",
      "timestamp": "2025-11-19T12:33:30Z"
    }
  ],
  "target_languages": ["en", "th"]
}

```

#### FR-3：文脈考慮

* 翻訳時、直近 **最大20件** のメッセージを文脈として LLM に渡す（bot自身の投稿は除外）。
* 文脈メッセージは取得時点の順序を使用し、厳密な順序保証は要求しない。
* 文脈には以下を含む：

  * sender_name
  * text
  * timestamp

#### FR-4：話者名は翻訳しない

* 各メッセージの発言者名は翻訳対象外とし、そのまま扱う。

---

### 3.2 言語設定機能

#### FR-5：ユーザー言語登録

* ボットがグループに招待された際（再招待含む）は、既存の言語設定をリセットし、以下のメッセージをグループ内へ送信して全員に再設定を促す：

```
Hello! I'm a multilingual translation bot. Please tell me the languages you want to translate to.
你好！我是一个多语言翻译机器人。请告诉我你想要翻译成哪些语言。
こんにちは！多言語翻訳ボットです。翻訳したい言語を教えてください。
สวัสดี! ฉันเป็นบอทแปลหลายภาษา กรุณาบอกฉันว่าคุณต้องการแปลเป็นภาษาใดบ้าง
ex) English, 中文, 日本語, ไทย
```

* 単一ユーザーから友だち追加された場合は言語設定は不要で、簡単な挨拶メッセージのみ送信する（多言語グループ前提のフローは実行しない）。
* ユーザーが言語名を返信すると、直前メッセージに含まれる言語を Gemini で抽出し（ISO コード＋自然文）、空の結果でなければ「確認テンプレート」で一括確認を行う。テンプレート内の文面・ボタンテキストも Gemini 生成の自然文を使用し、絵文字（🆗/↩️）のみ固定する。主要言語（メッセージ全体の主要言語を優先）でボタンテキストを表示し、他言語は本文中に多言語で提示する。
* テンプレートで「完了（🆗）」が押された場合は、登録した言語リストを多言語で再通知しつつ `group_user_languages` に保存する。「変更する（↩️）」が押された場合は「設定を取り消しました。再度、翻訳したい言語をすべて教えてください。」等の文面を送信し、DB には反映しない。
```json
{
  "type": "template",
  "altText": "this is a confirm template",
  "template": {
    "type": "confirm",
    "text": "日本語を追加しますか？",
    "actions": [
      {
        "type": "postback",
        "label": "はい",
        "data": "language_enroll=ja&enroll=true"
      },
      {
        "type": "postback",
        "label": "いいえ",
        "data": "language_enroll=ja&enroll=false"
      }
    ]
  }
}
```
 https://developers.line.biz/ja/reference/messaging-api/#template-messages
* ユーザーが「はい」と返信した場合、言語設定を保存する（MVPでは追加のみを扱い、更新・削除は対応しない）。
* ユーザーが「いいえ」と返信した場合、言語設定は保存しない。
* LLM で言語名を正規化し、ISO 言語コード（例：`en`）に変換して保存する。入力形式は自由（自然文／絵文字など任意）で受け付け、正規化に失敗または抽出結果が空の場合は言語指定ではないメッセージとみなし、レスポンスを返さず無視する。

* 追加要件（memberJoined イベント）:
  * グループに新メンバーが追加されたとき、ボットは以下の多言語メッセージで歓迎し、言語設定の変更方法を案内する：

```
Hello <参加者名> !

When you want to change the interpreter's language settings, please remove this bot from the group once and then invite it again!

通訳の言語設定を変更するときは、このボットを一度グループから削除してから、再度招待してね！

如果你想更改口译语言设置，请先将此机器人从群组中删除，然后再重新邀请它！

หากคุณต้องการเปลี่ยนการตั้งค่าภาษาของล่าม กรุณานำบอทนี้ออกจากกลุ่มก่อน แล้วค่อยเชิญกลับมาอีกครั้ง!
```

  * ただし、**ボットがグループに参加してから10分以内に追加された新メンバー**については、このメッセージを送信しない（再招待直後のスパムを防止）。ボット自身のユーザーIDは存在しないため、グループ毎に特殊な `user_id="__bot_join__"` レコードで参加時刻を記録して判定する。

#### FR-6：対応可否判定

* Gemini により、その言語が翻訳可能か判定する。
* 未対応言語が含まれている場合は、以下の多言語メッセージで通知した後、対応可能な言語だけを使って確認テンプレートを送信する。対応可能な言語が 1 つも無い場合は通知のみで終了し、テンプレートは送信しない。
```
シルボ語には通訳対応できません。
I cannot provide interpretation for Silbo language.
ฉันไม่สามารถให้บริการล่ามสำหรับภาษาซิลโบได้
我無法提供席耳波語的口譯服務。
```

#### FR-7：グループ内の言語保持

* グループ内の全メンバーの言語設定を保持し、翻訳先選定に使用。言語設定自体は `group_user_languages` テーブルでユーザー毎に複数言語を管理し、確認テンプレートで「完了（🆗）」が押されたときにまとめて登録する。言語設定の可視化・更新機能は現時点では提供しない。

---

### 3.3 メッセージ履歴保持

#### FR-8：メッセージログ保存

* 各メッセージを Neon に保存し、CloudWatch Logs で必要な計測を行う（追加の分析基盤は不要）。
* 翻訳時の文脈として **直近20件** を取得する。20件未満の場合は取得できたメッセージすべてを文脈として渡し、補間は行わない。

#### FR-9：保存期間

* MVP段階では **半永久保存** とする。

---

### 3.4 外部サービス連携

#### FR-10：Gemini 2.5 Flash 連携

* Structured Output（JSON Schema）で安定した翻訳結果を取得する。
* LLMコールは **1回のみ**。
* プロンプトでは話者名・メンションを翻訳対象から除外し、翻訳結果内にも原文のまま残すよう指示する。

#### FR-11：LINE Messaging API

* 翻訳結果は Reply API / Push API で送信する。

#### FR-12：NeonDB連携

* 言語設定
* メッセージ履歴
  を取得・保存する。

---

## 4. 非機能要件（Non-Functional Requirements）

---

### 4.1 パフォーマンス

#### NFR-1：応答速度

* 翻訳メッセージ生成完了まで **200–350ms 前後** を目標とする。
* Webhook 受信時の応答は **1秒以内に 200 OK** を返す。
* 文脈取得や翻訳処理では明示的なタイムアウトを設けず、AWS / Gemini API の標準タイムアウトに従う。

#### NFR-2：LLM 呼び出し回数

* 翻訳時の LLM 呼び出しは **1回** に統一。

#### NFR-3：DBアクセス数

* メッセージ処理時の Neon へのアクセスは **最大2回** に制限する：

  * 言語設定取得 1 回
  * 文脈20件取得 1 回

---

### 4.2 可用性

#### NFR-4：障害時対応

* LLMまたはNeon障害時や、翻訳失敗時は当該メッセージを無視して終了する（ユーザーへの追加返信なし）。
* 部分的に成功した場合は、取得できた翻訳結果のみ返信する。
* LLM からの壊れたレスポンスを受け取った場合は最大3回まで再試行し、それでも失敗すれば無視とする。
* 連続5回以上エラーの場合、管理者へ通知（後日実装可）。

---

### 4.3 セキュリティ

#### NFR-5：署名検証

* LINE Webhook の `X-Line-Signature` を検証し不正リクエストを拒否。

#### NFR-6：API鍵管理

* LINE / Gemini / Neon の認証情報は Lambda の環境変数で管理。

#### NFR-7：安全なログ管理

* 個人情報を含むログへのアクセスは制御する。
* MVP段階ではデータ削除運用は考慮せず、将来の機能追加で対応する。

---

### 4.4 拡張性

#### NFR-8：構成のシンプルさ

* MVPでは高速動作を優先し、以下は使用しない：

  * キャッシュ（Redis / Upstash）
  * SQS
  * Step Functions
  * 多段Lambda
  * CDK/Terraform

#### NFR-9：モジュール分離

* 翻訳ロジックと外部APIロジックを分離し、将来の LLM 切替が容易であること。

---

## 5. システム構成要件（Architecture Requirements）

---

### 5.1 全体構成

```
LINE → API Gateway → Lambda
                      ├→ NeonDB
                      ├→ Gemini 2.5 Flash
                      └→ LINE API Reply
```

---

### 5.2 Lambda（Python）

* Runtime: Python 3.12
* Handler: `lambda_handler.lambda_handler`

主要役割：

1. LINE Webhook イベント受信
2. すぐ 200 を返却
3. 言語設定取得（Neon）
4. 文脈取得（Neon）
5. 翻訳先言語リスト生成（ロジックのみ）
6. Gemini 2.5 Flash に Structured Output 翻訳依頼
7. LINE Messaging API に送信

---

### 5.3 NeonDB（PostgreSQL）

#### テーブル：`group_members`

| column         | type        | note     |
| -------------- | ----------- | -------- |
| group_id       | TEXT        | PK       |
| user_id        | TEXT        | PK       |
| preferred_lang | VARCHAR(10) | ISO言語コード |
| updated_at     | TIMESTAMP   |          |

#### テーブル：`messages`

| column    | type      | note          |
| --------- | --------- | ------------- |
| id        | SERIAL    | PK            |
| group_id  | TEXT      |               |
| user_id   | TEXT      |               |
| text      | TEXT      |               |
| timestamp | TIMESTAMP | DEFAULT NOW() |

---

### 5.4 Gemini（LLM）

* モデル：**Gemini 2.5 Flash**
* 要求：

  * Structured Output（JSON Schema）
  * context（20件まで）
  * output JSON に余計な内容は含めない
* JSON Schema：
```json
{
  "type": "object",
  "properties": {
    "source_text": { "type": "string" },
    "detected_source_language": { "type": "string" },
    "translations": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "language_code": { "type": "string" },
          "text": { "type": "string" }
        },
        "required": ["language_code", "text"]
      }
    }
  },
  "required": ["source_text", "translations"]
}
```

---

## 6. データフロー（Data Flow）

1. ユーザーがメッセージ送信
2. LINE → Webhook → API Gateway → Lambda
3. Lambda が即 200 OK
4. Lambda 内部で非同期処理：

   * group_members 取得
   * messages 取得（20件）
   * target_languages を決定
   * Gemini に翻訳要求
   * 翻訳結果を LINE へ返信
   * messages に原文を保存
5. グループに翻訳結果が表示される

---

## 7. 制約（Constraints）

* LINE Webhook 応答は 2 秒以内
* LLM API のレート制限を遵守
* Neon 接続は Lambda から直接行う（Connection pooling は使用しない）
* 高速化のため費用最優先ではなく性能を優先（Gemini Flash）

---

## 8. 今後の拡張（Future Work）

（MVP後に検討）

* キャッシュ導入（Upstash Redis）
* 管理画面（Next.js）
* 過去ログのアーカイブ
* 課金システム（Stripe）
