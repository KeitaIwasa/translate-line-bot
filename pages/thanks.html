<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Thank you | Translate Line Bot</title>
  <link rel="preconnect" href="https://js.stripe.com">
  <style>
    :root {
      --bg: #0a2d4d;
      --card: #ffffff;
      --accent: #0c8cfc;
      --text: #0f172a;
      --muted: #475569;
      --success: #16a34a;
      --warning: #ea580c;
      --radius: 14px;
      --shadow: 0 18px 40px rgba(0,0,0,0.18);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Segoe UI", "Hiragino Sans", system-ui, -apple-system, sans-serif;
      background: radial-gradient(circle at 20% 20%, rgba(255,255,255,0.12), transparent 32%),
                  radial-gradient(circle at 80% 0%, rgba(255,255,255,0.08), transparent 36%),
                  var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 32px 16px;
    }
    .card {
      width: 100%;
      max-width: 520px;
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 28px 24px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 10px 16px;
      border-radius: 999px;
      background: #e0f2fe;
      color: #0369a1;
      font-weight: 700;
      margin-bottom: 14px;
      font-size: 14px;
    }
    h1 { margin: 6px 0 6px; font-size: 22px; }
    .amount { font-size: 28px; font-weight: 800; margin: 6px 0 2px; }
    .status { font-size: 15px; color: var(--muted); margin: 0 0 18px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 18px 0; }
    .pill {
      background: #f8fafc;
      border-radius: 10px;
      padding: 12px;
      text-align: left;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.5;
    }
    .pill strong { color: var(--text); }
    .actions { display: flex; flex-direction: column; gap: 12px; margin-top: 10px; }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 14px;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      font-weight: 700;
      font-size: 15px;
      transition: transform 0.1s ease, box-shadow 0.1s ease, opacity 0.1s;
    }
    .btn-primary { background: linear-gradient(120deg, #0c8cfc, #1d4ed8); color: #fff; box-shadow: 0 10px 28px rgba(12,140,252,0.35); }
    .btn-secondary { background: #e2e8f0; color: #0f172a; }
    .btn:hover { transform: translateY(-1px); }
    .alert { margin: 12px 0 0; font-size: 13px; color: var(--muted); }
    .error { color: #dc2626; font-weight: 700; }
    footer { margin-top: 18px; font-size: 12px; color: #cbd5e1; text-align: center; }
    @media (max-width: 480px) {
      .grid { grid-template-columns: 1fr; }
      .card { padding: 22px 18px; }
    }
  </style>
</head>
<body>
  <div class="card" id="card">
    <div class="badge">ğŸ‰ Payment Completed</div>
    <h1>ã”åˆ©ç”¨ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™</h1>
    <div class="amount" id="amount">èª­ã¿è¾¼ã¿ä¸­...</div>
    <p class="status" id="status">æ±ºæ¸ˆæƒ…å ±ã‚’å–å¾—ã—ã¦ã„ã¾ã™ã€‚</p>

    <div class="grid">
      <div class="pill"><strong>è«‹æ±‚æ›¸ç•ªå·</strong><br><span id="invoice-number">-</span></div>
      <div class="pill"><strong>æ”¯æ‰•ã„æ—¥</strong><br><span id="invoice-date">-</span></div>
    </div>

    <div class="actions">
      <button class="btn btn-primary" id="open-line">LINE ã‚’é–‹ã</button>
      <a class="btn btn-secondary" id="open-invoice" href="#" target="_blank" rel="noopener">è«‹æ±‚æ›¸ã‚’é–‹ã</a>
    </div>
    <p class="alert" id="alert">ãƒ¢ãƒã‚¤ãƒ«ç«¯æœ«ã§ã¯è‡ªå‹•ã§ LINE ã‚’é–‹ãã¾ã™ã€‚é–‹ã‹ãªã„å ´åˆã¯ãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚</p>
  </div>
  <footer>Powered by Stripe | translate.iwasadigital.com</footer>

  <script src="https://js.stripe.com/v3/"></script>
  <script>
    // å…¬é–‹éµã¯ç’°å¢ƒã”ã¨ã«å·®ã—æ›¿ãˆå¿…é ˆ
    const STRIPE_PUBLISHABLE_KEY = (window.ENV_STRIPE_PUBLISHABLE_KEY || 'REPLACE_WITH_STRIPE_PUBLISHABLE_KEY').trim();

    const params = new URLSearchParams(window.location.search);
    const sessionId = params.get('session_id');
    const statusParam = params.get('status');
    const lineLink = params.get('line_link') || 'line://launch';

    const els = {
      amount: document.getElementById('amount'),
      status: document.getElementById('status'),
      invoiceNumber: document.getElementById('invoice-number'),
      invoiceDate: document.getElementById('invoice-date'),
      openInvoice: document.getElementById('open-invoice'),
      alert: document.getElementById('alert'),
    };

    const isMobile = /iphone|ipad|ipod|android/i.test(navigator.userAgent);

    function showError(message) {
      els.amount.textContent = 'è¡¨ç¤ºã§ãã¾ã›ã‚“';
      els.status.innerHTML = `<span class="error">${message}</span>`;
      els.alert.textContent = 'ãŠæ‰‹æ•°ã§ã™ãŒç®¡ç†è€…ã¸ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚';
    }

    function formatYMD(dateStr) {
      if (!dateStr) return '-';
      try {
        const d = new Date(dateStr * 1000 || dateStr);
        return `${d.getFullYear()}å¹´${d.getMonth() + 1}æœˆ${d.getDate()}æ—¥`;
      } catch (_e) {
        return '-';
      }
    }

    function attemptLineDeepLink() {
      // ãƒ¢ãƒã‚¤ãƒ«ã®ã¿è‡ªå‹•é·ç§»ã€‚PCã¯ãƒœã‚¿ãƒ³ã®ã¿ã€‚
      if (!isMobile) return;
      setTimeout(() => { window.location.href = lineLink; }, 400);
    }

    async function hydrate() {
      if (!sessionId) {
        showError('session_id ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
        return;
      }
      if (!STRIPE_PUBLISHABLE_KEY || STRIPE_PUBLISHABLE_KEY.startsWith('REPLACE_WITH_')) {
        showError('Stripe ã®å…¬é–‹éµãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
        return;
      }

      if (statusParam === 'cancelled') {
        els.amount.textContent = 'æœªæ±ºæ¸ˆ';
        els.status.textContent = 'ãŠæ”¯æ‰•ã„ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸã€‚å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
        els.alert.textContent = 'LINE ã®è‡ªå‹•é·ç§»ã¯è¡Œã‚ã‚Œã¾ã›ã‚“ã€‚';
        return;
      }

      try {
        const stripe = Stripe(STRIPE_PUBLISHABLE_KEY);
        const { error, session } = await stripe.retrieveCheckoutSession(sessionId);
        if (error || !session) {
          showError('æ±ºæ¸ˆæƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
          return;
        }

        const amountTotal = session.amount_total ? session.amount_total / 100 : 0;
        const currency = (session.currency || 'jpy').toUpperCase();
        els.amount.textContent = `Â¥${amountTotal.toLocaleString()} (${currency})`;
        els.status.textContent = session.payment_status === 'paid' ? 'ãŠæ”¯æ‰•ã„ãŒå®Œäº†ã—ã¾ã—ãŸã€‚' : 'ãŠæ”¯æ‰•ã„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';

        // hosted_invoice_url ã¯ã‚µãƒ–ã‚¹ã‚¯ã§ã‚ã‚Œã° invoice ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆçµŒç”±ã§å–å¾—å¯èƒ½
        const invoice = session.invoice;
        if (invoice) {
          els.invoiceNumber.textContent = invoice.number || '-';
          els.invoiceDate.textContent = formatYMD(invoice.status_transitions?.paid_at || invoice.created);
          if (invoice.hosted_invoice_url) {
            els.openInvoice.href = invoice.hosted_invoice_url;
          } else {
            els.openInvoice.removeAttribute('href');
            els.openInvoice.style.opacity = '0.6';
          }
        } else {
          els.invoiceNumber.textContent = '-';
          els.invoiceDate.textContent = '-';
        }

        // ãƒ¢ãƒã‚¤ãƒ«ãªã‚‰è‡ªå‹•ã§ LINE ã‚’é–‹ã
        attemptLineDeepLink();
      } catch (_e) {
        showError('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
      }
    }

    document.getElementById('open-line').addEventListener('click', () => {
      window.location.href = lineLink;
    });

    hydrate();
  </script>
</body>
</html>
